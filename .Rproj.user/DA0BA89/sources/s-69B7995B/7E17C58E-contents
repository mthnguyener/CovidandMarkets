library(stringr)
library(dplyr)
library(tidyverse)
library(tidyselect)
library(ggplot2)

#CURRENT
sum(is.na (shoes))
summary(shoes)

usshoes <- filter(shoes, prices.currency =="USD") %>%
  mutate(brand = tolower(brand))

brands.merged <- with(brands, aggregate(list(n = n), list(brand = tolower(brand)),sum))
brands.merged2 <- mutate(brands.merged, id = str_sub(brand,1,4))
brands.main <- group_by(brands.merged2, id) %>%
  summarize(count = sum(n))

#CURRENT
usshoes.tidy1 <- select(usshoes, id, brand, categories, colors, dateAdded, features, prices.amountMin, prices.amountMax, prices.color, prices.condition, prices.isSale, prices.merchant, prices.offer) %>%
  mutate(prices = (prices.amountMin + prices.amountMax)/2)

#CURRENT
avgprices <- group_by(usshoes.tidy, brand) %>%
  summarize(prices = mean(prices, na.rm = TRUE))

avgprices <- group_by(usshoes.tdy, brand) %>%
  summarize(Minavgprice = mean(prices.amountMin, na.rm = TRUE),  
            Maxavgprice = mean(prices.amountMax, na.rm = TRUE))

avgprices <- avgprices %>%
  mutate(prices = (Minavgprice + Maxavgprice)/2) %>%
  select(-Minavgprice, - Maxavgprice)

#CURRENT
brands <- count(usshoes.tidy, brand)

categories.merged <- count(shoes, categories)

usshoes.info <- usshoes.tidy1[complete.cases(usshoes.tidy),]


usshoes.info <- usshoes[,colSums(is.na(usshoes)) == 0]

#BRANDS 
usshoes.tidy <- usshoes.tidy1 %>%
  mutate(brand = case_when(str_detect(brand, "nike") ~ "nike",
                           str_detect(brand, "reebok") ~"reebok",
                           str_detect(brand, "adidas") ~"adidas",
                           str_detect(brand, "3n2") ~"3n2",
                           str_detect(brand, "academie") ~"academie ",
                           str_detect(brand, "alexander mcqueen") ~"alexander mcqueen",
                           str_detect(brand, "and 1") ~"and1",
                           str_detect(brand, "under armour") ~"under armour",
                           str_detect(brand, "wrangler") ~"wrangler",
                           str_detect(brand, "wolverine") ~"wolverine",
                           str_detect(brand, "vionic") ~"vionic",
                           str_detect(brand, "kenneth cole") ~"kenneth cole",
                           str_detect(brand, "north face") ~"north face",
                           str_detect(brand, "puma") ~"puma",
                           str_detect(brand, "converse") ~"converse",
                           str_detect(brand, "salomon") ~"salomon",
                           str_detect(brand, "sorel") ~"sorel",
                           str_detect(brand, "new balance") ~"new balance",
                           str_detect(brand, "clarks") ~"clarks",
                           str_detect(brand, "leg avenue") ~"leg avenue",
                           str_detect(brand, "timberland") ~"timberland",
                           str_detect(brand, "vans pro") ~"vans",
                           str_detect(brand, "vans footwear") ~"vans",
                           str_detect(brand, "vans av78") ~"vans",
                           TRUE ~ brand)) %>% 
  select(id, brand, categories, colors, dateAdded, features, prices.color, prices.condition, prices.isSale, prices.merchant, prices.offer, prices)

usshoes.tidy$brand = replace(x = usshoes.tidy$brand, 
                                    list =  !usshoes.tidy$brand %in% c('nike', 'reebok', 'adidas',
                                                                       'under armour', 'lacoste', 'clarks',
                                                                       'vans', 'timberland', 'converse', 
                                                                       'new balance', 'kenneth cole', 'north face',
                                                                       'salomon', 'puma', 'cole haan',
                                                                       'asics', 'brooks', 'mizuno'),
                                    values =  'others')

brands_n <- count(usshoes.tidy, brand)

brands <- group_by(usshoes.tidy, brand) %>%
  summarize(prices = mean(prices, na.rm = TRUE)) %>%
  left_join(brands_n, by = 'brand')

usshoes.tidy <- usshoes.tidy %>%
  mutate(categories = case_when(str_detect(categories, "All Men's Shoes") ~ "allmensshoes",
                                str_detect(categories, "Boot") ~"boots",
                                str_detect(categories, "Sneaker") ~"sneakers",
                                str_detect(categories, "Athletic") ~"athletic",
                                str_detect(categories, "Sport") ~"athletic",
                                str_detect(categories, "Oxford") ~"oxford",
                                str_detect(categories, "Loafer") ~"loafer",
                                str_detect(categories, "Dress") ~"dress",
                                str_detect(categories, "Casual") ~"casual",
                                str_detect(categories, "Sandals") ~"sandals",
                                str_detect(categories, "Boat") ~"boat",
                                str_detect(categories, "Slippers") ~"slippers",
                                TRUE ~ categories))

usshoes.tidy$categories = replace(x = usshoes.tidy$categories, 
                                    list =  !usshoes.tidy$categories %in% c('boots', 'sneakers',
                                                                              'athletic', 'oxford', 'loafer', 'dress',
                                                                              'casual', 'sandals', 'boat', 'slippers'),
                                    values =  'others')

#CATEGORIES
tidycategories <- tidyusshoes %>%
  mutate(categories = case_when(str_detect(categories, "All Men's Shoes") ~ "allmensshoes",
                           str_detect(categories, "Boot") ~"boots",
                           str_detect(categories, "Sneaker") ~"sneakers",
                           str_detect(categories, "Athletic") ~"athletic",
                           str_detect(categories, "Sport") ~"athletic",
                           str_detect(categories, "Oxford") ~"oxford",
                           str_detect(categories, "Loafer") ~"loafer",
                           str_detect(categories, "Dress") ~"dress",
                           str_detect(categories, "Casual") ~"casual",
                           str_detect(categories, "Sandals") ~"sandals",
                           str_detect(categories, "Boat") ~"boat",
                           str_detect(categories, "Slippers") ~"slippers",
                           TRUE ~ categories))

tidycategories$categories = replace(x = tidycategories$categories, 
                   list =  !tidycategories$categories %in% c('boots', 'sneakers',
                                                             'athletic', 'oxford', 'loafer', 'dress',
                                                             'casual', 'sandals', 'boat', 'slippers'),
                   values =  'others')
 
maincategories <- count(tidycategories, categories)

categories <- group_by(tidycategories, categories) %>%
  summarize(prices = mean(prices, na.rm = TRUE)) %>%
  left_join(maincategories, by = 'categories')

#GGPLOT
ggplot(usshoes.tidy, mapping = aes(x = dateAdded, y = prices)) +
  geom_point() +
  ggtitle("Shoes Prices (2014 - 2017)") + 
  xlab("Year") + ylab("Prices")

brands %>% filter(brand != "others") %>%
ggplot(brands, mapping = aes(x = n, y = prices)) +
  geom_point(aes(color = brand))

categories %>% filter(brand != "others") %>%
  ggplot(brands, mapping = aes(x = n, y = prices)) +
  geom_point(aes(color = brand))

ggplot(usshoes.tidy, mapping = aes(x = n, y = prices)) +
  geom_point(aes(color = categories))

ggplot(usshoes.tidy, mapping = aes(x = brand, y = prices)) +
  geom_point() +
  coord_flip() +
  theme(legend.position="none")

brandchart <- usshoes.tidy %>% filter(brand != "others") %>%
  filter(categories != "allmensshoes")

categorieschart <- usshoes.tidy %>% filter(categories != "others")

ggplot(data = brandchart, mapping = aes(x = brand, y = prices)) +
  geom_point() +
  facet_wrap(~ categories, nrow = 2) +
  coord_flip()

ggplot(data = categorieschart, mapping = aes(x = categories, y = prices)) +
  geom_point() +
  coord_flip()

#Measures of Central Tendency
Q3 <- quantile(usshoes.tidy$prices, 0.75)
Q1 <- quantile(usshoes.tidy$prices, 0.25)  
print (Q3 - Q1)
IQR(usshoes.tidy$prices)

median(usshoes.tidy$prices)
mean(usshoes.tidy$prices)

OutVals = boxplot(usshoes.tidy$prices)$out
which(usshoes.tidy$prices %in% OutVals)

OutVals = boxplot(usshoes.tidy$prices, plot=FALSE)$out

#WRITE TO CSV
write.csv(avgprices, file = "avgprices.csv")
write.csv(brands, file = "brands.csv")
write.csv(categories, file = "categories.csv")
write.csv(usshoes.info, file = "usshoes.csv")
write.csv(usshoes.tidy, file = "tidyusshoes.csv")
